<!DOCTYPE html>
<meta charset="utf-8">
<title>OBA Visualization (Map)</title>
<link rel="stylesheet" href="../d3.slider.css" />
<style>

body {
  font-family: Verdana,Arial,sans-serif;
}

h2 {
  font-size: 1.2em;
  margin: 60px 0 5px 0;
}

.wrapper div {
margin: 35px 0;
}

.wrapper {
  width: 960px;
}

.stop {
  stroke: #000;
  stroke-width: 0.0px;
  fill: #00d;
  fill-opacity: 0.2;
}

.segment {
  stroke: #999;
  stroke-opacity: .7;
  stroke-width: 1px;
}

.event {
  stroke: #000;
  stroke-width: 0.5px;
  fill: #d00;
  fill-opacity: 0.5;
}

.trip {
  stroke: #000;
  stroke-width: 0.5px;
}

body {
  margin: 0;
}

path {
  fill: none;
  stroke: #000;
  stroke-linejoin: round;
  stroke-linecap: round;
}

.major_road { stroke: #776; stroke-opacity: .4;}
.minor_road { stroke: #ccb; stroke-opacity: .4;}
.highway { stroke: #669; stroke-width: 1.2px; stroke-opacity: .4;}
.rail { stroke: #7de; stroke-opacity: .4;}
</style>
<body>
<div class="wrapper">
<div id="slider3"></div>
<h2>Time selected: <span id="slider3text">-</span></h2>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/d3.geo.tile.v0.min.js"></script>
<script src="../colorbrewer.js"></script>
<script src="../d3.slider.js"></script>
<script>

var width = 960,
    height = 960;

//var centerLong = -122.3491, centerLat = 47.6204, scale = 175000;
var centerLong = -122.3491, centerLat = 47.59, scale = 210000;

var numRoutes = {min:0, max:2};

var stopColors = d3.scale.ordinal()
    .range(colorbrewer.Set1[9]);
    //d3.scale.category20();
var routeColors = d3.scale.linear()
    .domain([numRoutes.min, numRoutes.max])
    .range(["black", "steelblue"])
    .interpolate(d3.interpolateLab);
var tripColors = d3.scale.linear()
    .domain([numRoutes.min, numRoutes.max])
    .range(["black", "red"])
    .interpolate(d3.interpolateLab);
/*
var force = d3.layout.force()
    .charge(-120)
    .linkDistance(30)
    .size([width, height]);
*/
var tiler = d3.geo.tile()
    .size([width, height]);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

var projection = d3.geo.mercator()
    //.rotate([122.2, 0, 0])
    .center([centerLong, centerLat])
    //.parallels([47.0, 49.0])
    .scale(scale)
    //.scale((1 << 15) / 2 / Math.PI)
var path = d3.geo.path()
    .projection(projection);

var txtFile = new XMLHttpRequest();
txtFile.open("GET", "seattle_neighborhoods/files", true);
txtFile.onreadystatechange = function()
{
  if (txtFile.readyState === 4) {  // document is ready to parse.
    if (txtFile.status === 200) {  // file is found
      allText = txtFile.responseText; 
      seattle_neighborhoods = txtFile.responseText.split("\n");
      seattle_neighborhoods.forEach(function(n) {
        d3.json("seattle_neighborhoods/"+n, function(collection) {
          svg.select("g") //.selectAll('path')
            //.datum(collection)
            .append('path')
            .datum(collection)
            .attr('d', d3.geo.path().projection(projection))
            .style('fill', '#eee')
            .style('fill-opacity', 0.2)
            .style('stroke', '#eee')
            .style('stroke-width', '0.75px');
        });
      })
    }
  }
}
txtFile.send(null);

//*
svg.selectAll("g")
    .data(tiler
      .scale(projection.scale() * 2 * Math.PI)
      .translate(projection([0, 0])))
  .enter().append("g")
    .each(function(d) {
      var g = d3.select(this);
      d3.json("http://" + ["a", "b", "c"][(d[0] * 31 + d[1]) % 3] + ".tile.openstreetmap.us/vectiles-highroad/" + d[2] + "/" + d[0] + "/" + d[1] + ".json", function(error, json) {
        g.selectAll("path")
            .data(json.features.sort(function(a, b) { return a.properties.sort_key - b.properties.sort_key; }))
          .enter().append("path")
            .attr("class", function(d) { return d.properties.kind; })
            .attr("d", path);
      });
    });
//*/

var tripStops = null;
var tripInstances = null;

// load stations
d3.json("stops_21767755.json", function(error, graph) {
  tripStops = graph;
  createLinks(tripStops, "stop", "segment", 3);
});

d3.json("trip_instances_21767755.json", function(error, graph) {
  tripInstances = graph;
  createLinks(tripInstances, "event", "trip", schedDev2Radius);
});

function schedDev2Radius(d) { 
  var delay = Math.max(0, d.sched_dev)
  var r = Math.sqrt(delay + 4)/10.0; 
  if(isNaN(r)) { 
    console.log(delay);
    return 0; 
  } else return r;
}

function createLinks(graph, nodeClass, linkClass, nodeRadius) {
  var link = svg.selectAll(".link")
      .data(graph.links)
    .enter().append("line")
      .attr("class", linkClass)
      .attr("x1", function(d) { return projection(graph.nodes[d.source].coords.coordinates)[0]; })
      .attr("y1", function(d) { return projection(graph.nodes[d.source].coords.coordinates)[1]; })
      .attr("x2", function(d) { return projection(graph.nodes[d.target].coords.coordinates)[0]; })
      .attr("y2", function(d) { return projection(graph.nodes[d.target].coords.coordinates)[1]; })
      //.style("stroke-width", function(d) { return Math.sqrt(d.value); })
      .style("stroke", function(d) { return routeColors(d.value); });

  var node = svg.selectAll(".node")
      .data(graph.nodes)
    .enter().append("circle")
      .attr("class", nodeClass)
      .attr("cx", function(d) { return projection(d.coords.coordinates)[0]; })
      .attr("cy", function(d) { return projection(d.coords.coordinates)[1]; })
      .attr("r", nodeRadius)
      //.style("fill", function(d) { return nodeColors(d.group); })

  node.append("title")
      .text(function(d) { return JSON.stringify(d); });
  link.append("title")
      .text(function(d) { return JSON.stringify(d); });
}

function redrawLinks(graph, value) {
  var hour = Math.floor(value);
  var minutes = Math.round((value - hour)*60.0/10.0);
  d3.select('#slider3text').text(hour + ":" + minutes + "*");
  var nodes = svg.selectAll(".event")
                .data(graph.nodes);
  console.log(nodes);
  nodes.transition()
    .duration(500)
    .attr("opacity", function(d) { 
      if(d.name.indexOf("_"+hour+":"+minutes) != -1) return 1.0;
      else return 0.0; });
      /*.attr("r", function(d) { 
      if(d.name.indexOf("_"+value+":") != -1) return schedDev2Radius(d);
      else return 0; })*/
}

d3.select('#slider3')
  .call(d3.slider()
    .on("slide", function(evt, value) {
      redrawLinks(tripInstances, value);
    })
    .axis(true)
    .min(10.5)
    .max(13.5)
    .step(1.0/6.0)
    //.axis(d3.svg.axis().ticks(22))
  );

</script>
</div>
</body>